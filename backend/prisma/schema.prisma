generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
}

model User {
  userId String @id @default(dbgenerated("NEWSEQUENTIALID()")) @db.UniqueIdentifier

  email String @unique @db.VarChar(50)

  password String @db.VarChar(80)

  fullName String  @db.NVarChar(100)
  jobTitle String? @db.NVarChar(100)

  // Giữ lại dòng này, xóa dòng trùng ở dưới
  isTutorialCompleted Boolean @default(false)

  languageCode String @default("jp") @db.VarChar(3)
  themeMode    String @default("light") @db.VarChar(7)

  // --- ĐÃ XÓA DÒNG isTutorialCompleted BỊ TRÙNG Ở ĐÂY ---

  createdAt DateTime @default(now()) @db.DateTime2

  chatsAsUserOne Chat[]    @relation("UserOne")
  chatsAsUserTwo Chat[]    @relation("UserTwo")
  messagesSent   Message[]

  @@map("Users")
}

model Chat {
  chatId    String   @id @default(dbgenerated("NEWSEQUENTIALID()")) @db.UniqueIdentifier
  userOneId String   @db.UniqueIdentifier
  userTwoId String   @db.UniqueIdentifier
  updateAt  DateTime @default(now()) @updatedAt @db.DateTime2

  userOne  User      @relation("UserOne", fields: [userOneId], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  userTwo  User      @relation("UserTwo", fields: [userTwoId], references: [userId], onDelete: NoAction, onUpdate: NoAction)
  messages Message[]

  // Đảm bảo tính duy nhất của cặp chat
  @@unique([userOneId, userTwoId], name: "UQ_ConversationPair")
  // Index để sort nhanh
  @@index([userOneId, updateAt(sort: Desc)], name: "IDX_Chat_UserOne_Sort")
  @@index([userTwoId, updateAt(sort: Desc)], name: "IDX_Chat_UserTwo_Sort")
  @@map("Chat")
}

model Message {
  messageId         String  @id @default(dbgenerated("NEWSEQUENTIALID()")) @db.UniqueIdentifier
  chatId            String  @db.UniqueIdentifier
  senderId          String  @db.UniqueIdentifier
  content           String  @db.NVarChar(Max)
  aiAnalysisContent String? @db.NVarChar(Max)

  createdAt DateTime @default(now()) @db.DateTime2
  isRead    Boolean  @default(false)
  chat      Chat     @relation(fields: [chatId], references: [chatId], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [userId], onDelete: NoAction, onUpdate: NoAction)

  @@index([chatId, createdAt(sort: Desc)], name: "IDX_Messages_GetContent")
  @@map("Messages")
}
